<!DOCTYPE html><html>  <head>    <meta content="text/html; charset=UTF-8" http-equiv="content-type">    <title>Synchronization</title>    <link href="../css/main.css" rel="stylesheet" type="text/css">    <script type="text/javascript" src="/jsc/app.js"></script>  </head>  <body>    <article class="content">      <h2>Synchronization</h2>      <p>Data stored in client side storage mechanism is <a href="https://developers.google.com/chrome/whitepapers/storage">ephemeral</a>,        although it may be possible to specified as persistent storage in the        future through <a href="http://www.w3.org/TR/quota-api/">quota          management API</a>. User agents are allowed to wipe out data anytime        if deem necessary such as in case of low disk space or exceeding quota        limit. For example mobile Safari browser will arbitrarily limit storage        size to 50MB. Browser will not inform data lost to user or script.        Critical data must be send back to the server.</p>      <p>Synchronization logic can be implemented by pre-database or in-database        process.</p>      <p> In pre-database synchronization technique, database is used as        secondary storage or caching. This technique required no additional        functionality from database library. StoreEvent and RecordEvent dispatch        from the storage instance may useful in this scenario.</p>      <p>In-database synchronization are handled by the library. Library usage        is similar to non-synchornization usage. But, additional configuration        and handler HTTP request are to be implemented. Before discussing        synchronization process, we need to understand how the library handle        cache invalidation and conflict resolution. These processes require        metadata for each resource (record in this library, model in MVC        architecture). </p>      <h3>Metadata</h3>      <p>Metadata are specified in HTTP respond headers. For performance reason,        several standardized URL format exist to retrieved only metadata for a        specific resource or a list of resources (also know as collection        resource). Metadata are store in client database along with the record        value or in separate medata data store. Upon retrieval, these metadata        are stripped from record value, but it may set to keep in record value        as well through configuration.&nbsp;</p>      <p>HTTP header name are case insensitive. This library always use lower        case header name as metadata attribute name. </p>      <p>It should be noted that, for cross domain request, header name must be        exposed setting <a href="https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS">          Access-Control-Expose-Headers</a> in origin server.</p>      <p><a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.11">etag</a>:        Entity tag is used for cache invalidation and conditional retrieval and        update.</p>      <p><a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.29">last-modified</a>:        Last modified time value is used for conflict resolution. In case of        conflicting update in both client and server, an algorithm may        automatically set last modified entity as winner. Additionally,&nbsp;if        etag is not exposed, last modified time value is used for conditional        retrieval and update. It should be note however that last modified time        value is only accurate to second. </p>      <p><a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.21">expires</a>:        The Expires entity-header field gives the time after which the response        is considered stale. If Expires header field is not expose, it is        calculated from Cache-Control's <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9.3">max-age</a>        value, if it presents.</p>      <p>date: Date refer to as current time value, which is not read from HTTP        header, but set by using <code>Date.now()</code> at the time of storing        metadata. Date value may be used to invalidate cache.</p>      <p>key: Resource key is URI path. Generally this is same as record key,        but may have namespace prefix.</p>      <h3>Cache invalidation</h3>      <p>Any database CRUD operation requires to invalidate the resource to        origin server for freshness. There are two levels of invalidation for a        read operation, opportunistic cache invalidation and conditional        retrieval. Opportunistic cache invalidation use expires medata value for        freshness. If resource entity is not expired, GET request is noted send        to origin server for reading the entity. Immutable store also never send        GET request if a record exist in the client database. Otherwise a        conditional GET request is send either with If-None-Match etag or        If-Unmodified-Since last-updated precondition. For write operation,        If-Match etag or If-None-Match last-updated precondition is used. &nbsp;      </p>      <h3>Conflict resolution</h3>      <p>&nbsp;All database write operation send the request with either with        ETag or Last-Updated&nbsp; pre-condition. In case of failing        precondition, the deferred object invoke fail callback with        ConflictEvent, which encapsulate both client and server record value        including metadata. If the Event object is not resolved in the fail        callback, the event is resolve by default algorithm. <br>        <meta charset="utf-8">      </p>      <h3>Synchronizing with a RESTful service </h3>      Synchronizing with RESTful service is pretty straight forward. The      following example use <a href="https://checkvist.com/auth/api">Checkvist        Open API</a>, which follow REST principles for obtaining and updating      the data. Currently the API does not expose medata data on entity request      header. For entity 'checklists', the resource URI and sample data for key      190078 is:<br>      <pre>https://beta.checkvist.com/checklists/190078.json</pre>      <pre>{  id: 190078  name: "test sync app"  public: false  updated_at: "2013/06/08 22:57:09 +0000"  user_count: 1  user_updated_at: null}</pre>      <a href="/api-reference/ydn-db/schema.html#sync">Store schema</a> is      declared as follow: &nbsp;      <pre>var schema = {    stores: [{      name: 'checklists',      keyPath: 'id',      Sync: {        format: 'json',        transport: service,        Options: {          baseUri: '/',          delimiter: '/'        }      }    }]  };</pre>      <p>The <code>Sync</code> attribute value specify synchronization        information of the store. HTTP requests are made by HTTP transport        service object specified by <code>transport</code> attribute in <code>Sync</code>        options. A HTTP transport service is an object which has a method of <code>request</code>,        which take argument object having fields of </p>      <ul>        <li>path - type: string: The URL to handle the request.</li>        <li>method - type: string: The HTTP request method to use. Default is          'GET'.</li>        <li>params - type: Object: URL params in key-value pair form.</li>        <li>headers - type: Object: Additional HTTP request headers.</li>        <li>body - type: string: The HTTP request body (applies to PUT or POST).</li>        <li>callback - type: Function: HTTP response object having the following          fields described below.</li>      </ul>      <p>Response object has the following fields</p>      <ul>        <li>url - type: string: The input URL.</li>        <li>status - type: string: HTTP response status.</li>        <li>contentType - type: string: HTTP response content type.</li>        <li>reponseText - type: string: HTTP response text.</li>        <li>response - type: Object: HTTP response.</li>      </ul>      It is similar to as defined in <a href="https://code.google.com/p/google-api-javascript-client/wiki/ReferenceDocs">Google
        Javascript client library</a>.<br>      <p>The following code snippet show how to make HTTP transport service:</p>      <pre>/** * Send request to checkvist server. * @link https://developers.google.com/api-client-library/javascript/reference/referencedocs#gapiclientrequest * @param {Object} args request arguments, compatible with Google javascript * client library. */CheckvistApp.prototype.request = function(args) {  var path = args.path;  var method = args.method || 'GET';  var params = args.params || {};  params['username'] = this.session.username;  if (this.session.token) {    params['token'] = this.session.token;  }  var host = 'beta.checkvist.com';  var url = 'https://' + host + path + '.json';  var query = [];  for (var q in params) {    query.push(q + '=' + encodeURIComponent(params[q]));  }  url += '?' + query.join('&amp;');  var req = new XMLHttpRequest();  req.open(method, url, false);  // req.withCredentials = true;  var me = this;  req.onload = function(e) {    var raw = {      body: req.responseText,      status: req.status,      statusText: req.statusText,      headers: {}    };    var header_lines = req.getAllResponseHeaders().split('\n');    for (var i = 0; i &lt; header_lines.length; i++) {      var idx = header_lines[i].indexOf(':');      if (idx &gt; 0) {        var name = header_lines[i].substr(0, idx).toLowerCase();        var value = header_lines[i].substr(idx + 1).trim();        raw.headers[name] = value;      }    }    args.callback(JSON.parse(req.responseText), raw);  };  console.info('sending ' + url);  req.send();};</pre>      <p>A complete offline application can be found <a href="http://dev.yathit.com/demo/checkvist/checkvist-sync.html">Checkvist          sync demo app</a>.</p>      <h3>Synchronizing with YDN-DB</h3>      <p>YDN-DB have build in synchronization support for AWS S3 (<a href="http://aws.amazon.com/documentation/s3/">Amazon
          simple storage service</a>), <a href="http://www.ietf.org/rfc/rfc4287.txt">ATOM
          syndicate format</a>, <a href="http://odata.org/">OData</a>, <a href="https://developers.google.com/gdata/">          GData</a>, GCS (<a href="https://developers.google.com/storage/">Google
          cloud storage</a>).</p>      <pre>var schema = {  stores: [    {      name: 'st',      Sync: {        format: 's3'        transport: gapi.client      }    }  ]};</pre>    </article>  </body></html>